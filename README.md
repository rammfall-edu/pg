# pg

## Подключение к базе данных

```bash
  psql -U имя_пользователя_внутри_базы -h хост -p порт -d имя_базы_данных
```
После вводите пароль в терминале и жмете ENTER

## Команды постреса

### Список всех баз данных
```bash
  \l
```
### Подключится к конкретной базе данных
```bash
  \c имя_базы_данных
```
### Мы можем увидеть слева от ввода в какой мы сейчас базе данных
```bash
todo=#
```
где todo имя базы данных
### Посмотреть список таблиц
```bash
\dt
```
### Чтобы выйти из БД
```bash
\q
```

## Команды SQL

### Создать БД
```sql
CREATE DATABASE имя_базы;
```
### Удалить БД
```sql
DROP DATABASE имя_базы;
```
### Создать таблицу
```sql

CREATE TABLE имя_таблицы (
  название_колонки её_тип доп_часть(опционально),
  название_колонки её_тип доп_часть(опционально)
);

```
## Примеры
### Например, создадим таблицу с названием products для хранения товаров и их количества. Представим, что мы хотели бы вести это в экселе. Мы бы там просто сделали колонки и ниже бы писали бы данные. Но давайте сделаю в базе данных

```sql
CREATE TABLE products (
  id SERIAL PRIMARY KEY,
  productName VARCHAR(30) NOT NULL,
  quantity INTEGER NOT NULL DEFAULT(0)
);
```

И вот вы сидите такой весь программист на складе, к вам приезжает грузовик с товарами и привез вам столы, 20 штук. Вы их принимаете и делаете запись в вашу БД, в табличку products

```sql
INSERT INTO products (productName, quantity) VALUES ('Table', 20);
```
Потом приезжает ещё грузовик и привез вам чашки, 300 штук. Вы приняли и вбили их в БД

```sql
INSERT INTO products (productName, quantity) VALUES ('cup', 300);
```

Потом вам звонит поставщик и говорит, что привезет завтра вам ананасы, но количество не знает ещё. Ну и вы решили заранее ввести их в БД

```sql
INSERT INTO products (productName) VALUES ('pineapple');
```


Вот вы сидите со своим postgres и столами, вам наконец звонит мебельный магазин и хочет у вас купить 10 столов, но вы забыли, хватит ли у вас столов, и решаете проверить их количество на вашем складе. 

```sql
SELECT * FROM products;
```
И вам выводится список всего с вашего склада

```sql
 id | productname | quantity
----+-------------+----------
  1 | Table       |       20
  2 | cup         |      300
  3 | pineapple   |        0
(3 rows)
```

Но вас утомило количество данных(представьте что у вас там тысячи товаров) и вы хотите увидеть только столы

```sql
SELECT * FROM products WHERE productname='Table';
```
И вам возвращает
```sql
 id | productname | quantity
----+-------------+----------
  1 | Table       |       20
(1 row)
```

Окей, но вас волнует только количество, а не все вместе, давайте узнаем только количество столов

```sql
SELECT quantity FROM products WHERE productname='Table';
```

И получаете что хотели

```sql
 quantity
----------
       20
(1 row)
```

Окей, у вас достаточно столов и вы решаете их продать, но вы не знаете за сколько вы хотите. Было бы круто хранить стоимость единицы в табличке рядом с товаром. Мы можем либо удалить табличку
```sql
DROP TABLE products;
```
Но тогда мы потеряем уже все данные, нам нужно добавить к существующей таблице. Значит нужно добавить колонку ```price``` к нашей табличке.

```sql
ALTER TABLE products ADD COLUMN price INTEGER NOT NULL DEFAULT(0);
```

Мы не можем здесь сделать без дефолта, ибо если укажем просто ```NOT NULL``` то у нас уже есть записи без цены и будет ошибка. Поэтому для существующих мы поставим 0
И давайте посмотрим наши товары
 

```sql
SELECT * FROM products;
```

```sql
 id | productname | quantity | price
----+-------------+----------+-------
  1 | Table       |       20 |     0
  2 | cup         |      300 |     0
  3 | pineapple   |        0 |     0
(3 rows)
```

И теперь вы решаете перед продажей столов, поставить стоимость. Значит нужно отредактировать уже сделанные записи.
Ставим стоимость для каждой записи

```sql
UPDATE products SET price = 200 WHERE id = 1;
```
```sql
UPDATE products SET price = 30 WHERE id = 2;
```
```sql
UPDATE products SET price = 15 WHERE id = 3;
```
И теперь проверим что там

```sql

SELECT * FROM products;

```

```sql
 id | productname | quantity | price
----+-------------+----------+-------
  1 | Table       |       20 |   200
  2 | cup         |      300 |    30
  3 | pineapple   |        0 |    15
(3 rows)
```

Окей, вот приезжает вам грузовик ананасов, 800 штук. Добавим количество


```sql
UPDATE products SET quantity = 800 WHERE id = 3;
```
И после проверим


```sql

SELECT * FROM products;

```

```sql
 id | productname | quantity | price
----+-------------+----------+-------
  1 | Table       |       20 |   200
  2 | cup         |      300 |    30
  3 | pineapple   |      800 |    15
(3 rows)
```

Окей, вы назвали стоимость и у вас согласились купить столы, но было бы хорошо вести учет продаж, значит для этого нужна ещё табличка. В табличке должна быть ссылка на товар, который мы продали, количество и сумма от сделки. Давайте сделаем и назовём таблицу ```sales```

```sql
CREATE TABLE sales (
  id SERIAL PRIMARY KEY,
  quantity INTEGER NOT NULL,
  sum INTEGER NOT NULL,
  productId INTEGER,
  FOREIGN KEY(productId) REFERENCES products(id)
);
```

И оформляем продажу, 10 столов по их стоимости. Нам значит нужно уменьшить количество товаров в табличке товаров, и сделать запись о продаже

```sql
UPDATE products SET quantity = 10 WHERE id = 1;
```
Но можем сделать гибче, чтобы самим не считать

```sql
UPDATE products SET quantity = quantity - 10 WHERE id = 1;
```
```sql
 id | productname | quantity | price
----+-------------+----------+-------
  2 | cup         |      300 |    30
  3 | pineapple   |      800 |    15
  1 | Table       |       10 |   200
(3 rows)
```

Добавим запись о продаже и доходе от сделки

```sql
INSERT INTO sales (quantity, sum, productid) VALUES (10, 200 * 10, 1);
```
И посмотрим сколько мы заработали уже от этой сделки

```sql
SELECT * FROM sales;
```

```sql
 id | quantity | sum  | productid
----+----------+------+-----------
  1 |       10 | 2000 |         1
(1 row)
```

Ура, уже есть 2000 и можно отдавать долги.

И тут у вас появилась идея, что нужно хранить базу покупателей и если он будет часто покупать вы будете назначать ему постоянную скидку. Значит нам нужно хранить имя нашего покупателя, его телефон и числом процент скидки. Также добавить к табличке продаж колонку на ссылку покупателя, чтобы мы могли видеть, сколько он покупает, и от этого решать, давать ему ссылку или нет. Значит делаем новую таблицу и обновляем старую

```sql
CREATE TABLE buyers (
  id SERIAL PRIMARY KEY,
  name VARCHAR(30) NOT NULL,
  phone VARCHAR(25) NOT NULL,
  discount INTEGER NOT NULL DEFAULT(0),
  CHECK (discount BETWEEN 0 AND 70)
);
```
Здесь мы сделали ещё проверку, что скидка имеет диапазон от 0 до 70, если будет не входить в этот диапазон, то будет ошибка

Теперь нужно обновить нашу таблицу продаж

```sql
ALTER TABLE sales ADD COLUMN buyerId INTEGER CONSTRAINT sales_buyers_fk_buyerid REFERENCES buyers(id);
```
Тут более сложный синтаксис, ибо просто так внешний ключ нельзя добавить. Если расшифровать это, то это означает табличка sales к buyers fk - FOREIGN KEY и через андерскор указываем колонку таблицы. Можете пока забить, это не частый кейс)

Такс, теперь добавим нашего первого покупателя к себе в базу

```sql
INSERT INTO buyers (name, phone) VALUES ('shmebli devil', '066 666 66 66');
```
И отредактируем его первую покупки, чтобы он у нас связался

```sql
UPDATE sales SET buyerid = 4 WHERE id = 1;
```

Потом посмотрим наши продажи

```sql
 id | quantity | sum  | productid | buyerid
----+----------+------+-----------+---------
  1 |       10 | 2000 |         1 |       4
(1 row)
```

Окей, у меня появляется покупатель, который хочет купить все мои ананасы, давайте в начале его добавим в базу. За такую большую покупку, добавим ему 5 процентов скидку

```sql
INSERT INTO buyers (name, phone, discount) VALUES ('fruits and goods', '063 098 02 02', 5);
```

```sql
Active code page: 1252
 id |       name       |     phone     | discount
----+------------------+---------------+----------
  2 | TEST             | TEST          |       20
  4 | shmebli devil    | 066 666 66 66 |        0
  5 | fruits and goods | 063 098 02 02 |        5
(3 rows)
```

И давайте продадим ему ананасы все и со скидкой. 

```sql
INSERT INTO sales (quantity, sum, productid, buyerid) VALUES (800, 15 * 800 * 0.95, 3, 5);
```
тут ```15``` стоимость, ```800``` количество и ```0.95``` это чтобы было 5 проц скидка 

И теперь уменьшим количество товара
```sql
UPDATE products SET quantity = quantity - 800 WHERE id = 3;
```

Смотрим продажи

```sql
 id | quantity |  sum  | productid | buyerid
----+----------+-------+-----------+---------
  1 |       10 |  2000 |         1 |       4
  2 |      800 | 11400 |         3 |       5
(2 rows)
```
